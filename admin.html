<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QUẢN TRỊ HỆ THỐNG</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;700&display=swap" rel="stylesheet">

<style>
    body { font-family: 'Be Vietnam Pro', sans-serif; background: #f4f6f8; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
    
    /* --- LOGIN CSS --- */
    #login-screen { position: fixed; inset: 0; background: #0078d4; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
    .login-box { text-align: center; width: 320px; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    .login-box h3 { color: #333; margin-top: 0; }
    .login-input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; margin-bottom: 15px; outline: none; box-sizing: border-box; }
    .btn-login { width: 100%; padding: 12px; border-radius: 8px; border: none; background: #005a9e; color: white; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.2s; }
    .btn-login:hover { background: #004274; }
    .error-msg { color: red; font-size: 13px; margin-top: 10px; display: none; }

    /* --- ADMIN CSS --- */
    #admin-wrapper { width: 100%; max-width: 600px; display: none; }
    .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .btn-logout { background: #ffcccc; color: #d32f2f; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; }

    .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .card h3 { margin-top: 0; font-size: 15px; color: #666; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; text-transform: uppercase; display: flex; align-items: center; gap: 8px; }
    
    /* Sub-header */
    .sub-header { font-size: 14px; font-weight: 700; margin: 15px 0 10px; display: flex; align-items: center; gap: 5px; }
    .txt-wheel { color: #E91E63; }
    .txt-lucky { color: #FFC107; }

    .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #2196F3; }
    input:checked + .slider:before { transform: translateX(24px); }
    
    .input-group { margin-bottom: 15px; }
    .input-group label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px; color: #555; }
    input[type="text"], input[type="datetime-local"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }

    .btn-save { background: #0078d4; color: white; width: 100%; padding: 15px; border-radius: 10px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; position: sticky; bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    
    .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.7); z-index: 1000; display: none; justify-content: center; align-items: center; }
    .spinner { width: 40px; height: 40px; border: 4px solid #ddd; border-top-color: #0078d4; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <i class="fas fa-shield-alt" style="font-size: 50px; color: #0078d4; margin-bottom: 15px;"></i>
            <h3>Đăng nhập Quản trị</h3>
            <input type="email" id="email" class="login-input" placeholder="Email Admin..." onkeydown="checkEnter(event)">
            <input type="password" id="password" class="login-input" placeholder="Mật khẩu..." onkeydown="checkEnter(event)">
            <button class="btn-login" onclick="handleLogin()">ĐĂNG NHẬP</button>
            <p id="login-error" class="error-msg"></p>
        </div>
    </div>

    <div class="loading-overlay" id="loading"><div class="spinner"></div></div>

    <div id="admin-wrapper">
        <div class="header-bar">
            <h2>⚙️ CẤU HÌNH</h2>
            <button class="btn-logout" onclick="handleLogout()">Đăng xuất <i class="fas fa-sign-out-alt"></i></button>
        </div>

        <div class="card">
            <h3><i class="fas fa-toggle-on"></i> Bật/Tắt Chức năng</h3>
            <div class="row"><span>Công cụ Date</span><label class="switch"><input type="checkbox" id="toggle-date"><span class="slider"></span></label></div>
            <div class="row"><span>Tra cứu Kho</span><label class="switch"><input type="checkbox" id="toggle-stock"><span class="slider"></span></label></div>
            <div class="row"><span>Xem Phép</span><label class="switch"><input type="checkbox" id="toggle-leave"><span class="slider"></span></label></div>
            <div class="row"><span>Vòng Quay</span><label class="switch"><input type="checkbox" id="toggle-wheel"><span class="slider"></span></label></div>
            <div class="row"><span>Hái Lộc</span><label class="switch"><input type="checkbox" id="toggle-lucky"><span class="slider"></span></label></div>
        </div>

        <div class="card">
            <h3><i class="fas fa-clock"></i> Cài đặt Thời gian Sự kiện</h3>
            
            <div class="sub-header txt-wheel"><i class="fas fa-dharmachakra"></i> 1. Vòng Quay May Mắn</div>
            <div class="input-group"><label>Bắt đầu:</label><input type="datetime-local" id="time-wheel-start"></div>
            <div class="input-group"><label>Kết thúc:</label><input type="datetime-local" id="time-wheel-end"></div>
            <div class="row"><span>Hẹn giờ Vòng quay?</span><label class="switch"><input type="checkbox" id="toggle-wheel-time"><span class="slider"></span></label></div>

            <hr style="border: 0; border-top: 1px dashed #ddd; margin: 20px 0;">

            <div class="sub-header txt-lucky"><i class="fas fa-gift"></i> 2. Hái Lộc Đầu Năm</div>
            <div class="input-group"><label>Bắt đầu:</label><input type="datetime-local" id="time-lucky-start"></div>
            <div class="input-group"><label>Kết thúc:</label><input type="datetime-local" id="time-lucky-end"></div>
            <div class="row"><span>Hẹn giờ Hái lộc?</span><label class="switch"><input type="checkbox" id="toggle-lucky-time"><span class="slider"></span></label></div>
        </div>

        <div class="card">
            <h3><i class="fas fa-link"></i> Quản lý Đường dẫn (Link)</h3>
            
            <div class="sub-header" style="color:#0078d4"><i class="fas fa-briefcase"></i> Công cụ làm việc</div>
            <div class="input-group"><label>Link Tính Date:</label><input type="text" id="url-date" placeholder="https://..."></div>
            <div class="input-group"><label>Link Tra Kho:</label><input type="text" id="url-stock" placeholder="https://..."></div>
            <div class="input-group"><label>Link Phép/Bù:</label><input type="text" id="url-leave" placeholder="https://..."></div>

            <div class="sub-header" style="color:#E91E63; margin-top:20px"><i class="fas fa-gamepad"></i> Game & Sự kiện</div>
            <div class="input-group"><label>Link Vòng quay:</label><input type="text" id="url-wheel" placeholder="https://..."></div>
            <div class="input-group"><label>Link Hái lộc:</label><input type="text" id="url-lucky" placeholder="https://..."></div>
        </div>

        <button class="btn-save" onclick="saveConfig()">LƯU CÀI ĐẶT</button>
        <button style="width:100%; margin-top:10px; background:none; border:none; color:#666; cursor:pointer; margin-bottom: 20px;" onclick="window.location.href='index.html'">Về trang chủ</button>
    </div>

<script>
    // ==========================================
    // ⚠️ ĐIỀN API SUPABASE CỦA BẠN VÀO ĐÂY
    // ==========================================
	const SUPABASE_URL = 'https://gpmuckoydhrokpioltem.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdwbXVja295ZGhyb2twaW9sdGVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3MTMzNTcsImV4cCI6MjA4MTI4OTM1N30.Fqe5U2hm_fERI6ZLc_FQ1SMh5F4sYOrxr8JqLlwLKI0';
        
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let currentConfig = {};

    function checkEnter(event) { if (event.key === "Enter") handleLogin(); }

    async function checkSession() {
        const { data: { session } } = await _supabase.auth.getSession();
        if (session) showAdminPanel();
        else document.getElementById('login-screen').style.display = 'flex';
    }

    async function handleLogin() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const errorMsg = document.getElementById('login-error');

        if(!email || !password) { errorMsg.style.display = 'block'; errorMsg.innerText = "Vui lòng nhập đủ thông tin!"; return; }

        showLoading(true);
        const { error } = await _supabase.auth.signInWithPassword({ email, password });
        showLoading(false);

        if (error) { errorMsg.style.display = 'block'; errorMsg.innerText = "Sai email hoặc mật khẩu!"; }
        else { showAdminPanel(); }
    }

    async function handleLogout() {
        await _supabase.auth.signOut();
        location.reload(); 
    }

    async function showAdminPanel() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('admin-wrapper').style.display = 'block';
        await loadConfig();
    }

    async function loadConfig() {
        showLoading(true);
        let { data, error } = await _supabase.from('app_settings').select('config_data').eq('id', 1).maybeSingle();
        showLoading(false);

        if (data && data.config_data) {
            currentConfig = data.config_data;
            fillForm(currentConfig);
        } else {
            alert("Lỗi tải dữ liệu: " + (error ? error.message : "Không tìm thấy"));
        }
    }

    function fillForm(cfg) {
        // Features
        document.getElementById('toggle-date').checked = cfg.features.date;
        document.getElementById('toggle-stock').checked = cfg.features.stock;
        document.getElementById('toggle-leave').checked = cfg.features.leave;
        document.getElementById('toggle-wheel').checked = cfg.features.wheel;
        document.getElementById('toggle-lucky').checked = cfg.features.lucky;
        
        // Time
        if(cfg.events?.wheel) {
            document.getElementById('time-wheel-start').value = cfg.events.wheel.start ? cfg.events.wheel.start.replace(' ', 'T') : "";
            document.getElementById('time-wheel-end').value = cfg.events.wheel.end ? cfg.events.wheel.end.replace(' ', 'T') : "";
            document.getElementById('toggle-wheel-time').checked = cfg.events.wheel.useTime;
        }

        if(cfg.events?.lucky) {
            document.getElementById('time-lucky-start').value = cfg.events.lucky.start ? cfg.events.lucky.start.replace(' ', 'T') : "";
            document.getElementById('time-lucky-end').value = cfg.events.lucky.end ? cfg.events.lucky.end.replace(' ', 'T') : "";
            document.getElementById('toggle-lucky-time').checked = cfg.events.lucky.useTime;
        }

        // Urls (Đầy đủ 5 món)
        document.getElementById('url-date').value = cfg.urls.date || "";
        document.getElementById('url-stock').value = cfg.urls.stock || "";
        document.getElementById('url-leave').value = cfg.urls.leave || "";
        document.getElementById('url-wheel').value = cfg.urls.wheel || "";
        document.getElementById('url-lucky').value = cfg.urls.lucky || "";
    }

    async function saveConfig() {
        showLoading(true);
        
        // Save Features
        currentConfig.features.date = document.getElementById('toggle-date').checked;
        currentConfig.features.stock = document.getElementById('toggle-stock').checked;
        currentConfig.features.leave = document.getElementById('toggle-leave').checked;
        currentConfig.features.wheel = document.getElementById('toggle-wheel').checked;
        currentConfig.features.lucky = document.getElementById('toggle-lucky').checked;

        // Save Time
        if(!currentConfig.events.wheel) currentConfig.events.wheel = {};
        currentConfig.events.wheel.start = document.getElementById('time-wheel-start').value.replace('T', ' ');
        currentConfig.events.wheel.end = document.getElementById('time-wheel-end').value.replace('T', ' ');
        currentConfig.events.wheel.useTime = document.getElementById('toggle-wheel-time').checked;
        currentConfig.events.wheel.msgBefore = currentConfig.events.wheel.msgBefore || "Sắp mở";
        currentConfig.events.wheel.msgLive = currentConfig.events.wheel.msgLive || "Đang diễn ra";
        currentConfig.events.wheel.msgAfter = currentConfig.events.wheel.msgAfter || "Kết thúc";

        if(!currentConfig.events.lucky) currentConfig.events.lucky = {};
        currentConfig.events.lucky.start = document.getElementById('time-lucky-start').value.replace('T', ' ');
        currentConfig.events.lucky.end = document.getElementById('time-lucky-end').value.replace('T', ' ');
        currentConfig.events.lucky.useTime = document.getElementById('toggle-lucky-time').checked;

        // Save URLs (Đầy đủ 5 món)
        currentConfig.urls.date = document.getElementById('url-date').value;
        currentConfig.urls.stock = document.getElementById('url-stock').value;
        currentConfig.urls.leave = document.getElementById('url-leave').value;
        currentConfig.urls.wheel = document.getElementById('url-wheel').value;
        currentConfig.urls.lucky = document.getElementById('url-lucky').value;

        const { error } = await _supabase.from('app_settings').update({ config_data: currentConfig }).eq('id', 1);
        showLoading(false);

        if (!error) alert("✅ Đã lưu thành công!");
        else alert("❌ Lỗi: " + error.message);
    }

    function showLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }
    checkSession();
</script>
</body>
</html>